<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head th:include="/credit/header" />

<body>
    <tt:constant enumcode="item-target-type,selection-grade-type,boolean-type" />
    <section class="content-header">
        <h1>项目管理</h1>
        <ol class="breadcrumb">
            <li><a href="/credit/template/item/index"><i class="fa fa-list-alt"></i>项目列表</a></li>
            <li class="active">项目详情</li>
        </ol>
    </section>
    <section class="content">
        <div class="box box-widget" id="item_model_container">
            <div class="box-header no-border">
                <h3 class="box-title">项目</h3>
                <div class="box-tools pull-right">
                    <a class="btn tonto-model-tool-view-btn" id="item_model_edit_btn" href="javascript:void(0)"><i class="fa fa-edit"></i>编辑</a>
                </div>
            </div>
            <div id="item_model_view" class="box-body">
                <form class="form-horizontal">
                    <div class="form-group">
                        <label for="itemName" class="col-sm-3 control-label">项目名称：</label>
                        <div class="col-sm-8">
                            <pre name="itemName" style="min-height:150px" class="form-control-static description"></pre>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="itemTargetType" class="col-sm-3 control-label">项目适用对象：</label>
                        <div class="col-sm-3">
                            <p name="itemTargetType" class="form-control-static description"></p>
                        </div>
                        <label for="isMultiple" class="col-sm-2 control-label">是否多选：</label>
                        <div class="col-sm-3">
                            <p name="isMultiple" class="form-control-static description"></p>
                        </div>
                    </div>
                </form>
            </div>
            <div id="item_model_edit" class="box-body" style="display: none">
                <form id="item_model_form" action="/credit/template/item/save" method="post" class="form-horizontal edit-body">
                    <div class="form-group">
                        <label for="itemName" class="col-sm-3 control-label"><i class="required-label fa fa-asterisk"></i>项目名称：</label>
                        <div class="col-sm-8">
                            <textarea name="itemName" rows="5" placeholder="请输入项目名称" class="form-control" required="required"></textarea>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="itemTargetType" class="col-sm-3 control-label"><i class="required-label fa fa-asterisk"></i>项目适用对象：</label>
                        <div class="col-sm-8">
                            <div name="itemTargetType" class="tonto-radio-constant" required="required" enumcode="item-target-type"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="isMultiple" class="col-sm-3 control-label"><i class="required-label fa fa-asterisk"></i>是否多选：</label>
                        <div class="col-sm-3">
                            <div name="isMultiple" class="tonto-radio-constant" required="required" enumcode="boolean-type"></div>
                        </div>
                    </div>
                    <div class="form-group form-button-bar">
                        <div class="col-sm-2 col-sm-offset-3">
                            <button type="button" id="item_model_form_submit_btn" class="btn btn-primary btn-block">保存</button>
                        </div>
                        <div class="col-sm-2 col-sm-offset-1">
                            <button type="button" id="item_model_form_cancel_btn" class="btn btn-default btn-block">取消</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        <div class="box box-widget">
            <div class="box-header no-border">
                <h3 class="box-title">选项<span style="color:#aaa">（只有一个结果选项的时候不需要编辑选项内容，只需要选择诚信等级）</span></h3>
                <div class="box-tools pull-right">
                </div>
            </div>
            <div id="selection_edit" class="box-body">
                <div id="selection_item_div">
                </div>
                <div id="selection_empty_view" onclick="addSelection()" class="dotted-line-btn" style="margin:10px">
                    <a href="javascript:void(0)" ><i class="glyphicon glyphicon-plus"></i>添加选项</a>
                </div>
            </div>
        </div>
    </section>
    <div class="col-sm-2 col-sm-offset-3 btn-back">
        <a href="javascript:save()" id="submitBtn" class="btn btn-primary btn-block">提交</a>
    </div>
    <div class="col-sm-2 col-sm-offset-1 btn-back">
        <a href="/credit/template/item/index" class="btn btn-default btn-block">返回</a>
    </div>
    <div th:include="/credit/footer" />
    <script type="text/javascript">
    var options = {
        id: "item_model",
        server: false,
        columns: [
            { title: "项目名称", name: "itemName", required: "required", inputType: "TEXTAREA" },
            { title: "项目适用对象", name: "itemTargetType", required: "required", inputType: "RADIO", enum: "item-target-type", colspan: 2 },
            { title: "是否多选", name: "isMultiple", required: "required", inputType: "RADIO", enum: "boolean-type" }
        ]
    }

    var selectionColumns = [
        { title: "选项名称", name: "selectionName", inputType: "TEXT" },
        { title: "选项诚信等级", name: "selectionGrade", enum: "selection-grade-type", required: "required", inputType: "SELECT" }
    ];

    var currentIndex = 0,
        selectionComs = [],
        itemModel;

    function addSelection(view, data) {
        var id = "selection_" + currentIndex;
        var html = generateHtml({
            id: id,
            headBorder: false,
            toolBtn: [{
                id: id + "_remove_btn",
                icon: "fa fa-remove",
                name: "删除",
                showIn: 'view',
                order: 999
            }],
            server: false,
            cancelBtn: false,
            formButtonBar: [{
                id: id + '_edit_cancel_btn',
                type: 'button',
                name: '取消',
                class: 'btn btn-default btn-block',
                order: 999
            }],
            boxHeaderClass: 'box-header no-border',
            boxStyle: '-webkit-box-shadow: none;box-shadow: none;border-radius: 0;border-bottom: 1px solid #f4f4f4;',
            columns: selectionColumns
        });
        var selectionContainer = $('<div id="' + id + '_container"></div>');
        $("#selection_item_div").append(selectionContainer);
        selectionContainer.html(html);
        $.initComponment($("#" + id + "_container"));

        var selectionModel = new tonto.Model(id, selectionColumns, {
            server: false
        });

        if (!view) {
            selectionModel.toEdit();
        }

        if (data) {
            selectionModel.setData(data);
        }

        var com = {
            model: selectionModel,
            index: currentIndex * 1,
            container: selectionContainer
        }

        selectionComs[currentIndex++] = com;

        $("#" + id + '_edit_cancel_btn').click(function() {
            if (com.model.data) {
                com.model.toView();
            } else {
                com.container.remove();
                selectionComs.splice(com.index, 1);
                delete com;
            }
        });

        $("#" + id + '_remove_btn').click(function() {
            layer.confirm('确定删除吗?', function(index) {
                com.container.remove();
                selectionComs.splice(com.index, 1);
                delete com;
                layer.close(index);
            });
        });
    }

    function save(confirm) {
        var data = itemModel.data;
        if (!data) {
            $.errorMessage("请输入并保存项目内容！");
            return;
        }

        if (selectionComs.length > 0) {
            var isOne = selectionComs.length == 1;
            data.selections = [];

            for (var i = 0; i < selectionComs.length; i++) {
                var item = selectionComs[i].model;
                var d = item.data;

                if (confirm !== true) {
                    if (item.isEdit()) {
                        layer.confirm("有正在编辑中的选项，如果继续提交则会丢弃编辑中的内容！", function(index) {
                            save(true);
                        });
                        return;
                    }
                }

                if (!isOne && (!d.selectionName || d.selectionName.length == 0)) {
                    $.errorMessage("多个选项时必须填写选项名称以区分！");
                    return;
                }

                data.selections.push(d);
            }

            $.postJsonAjax("/credit/template/item/save", data, function(result) {
                $.successAlert("保存成功", function() {
                    window.location = '/credit/template/item/index';
                });
            }, $("#submitBtn"));

        } else {
            $.errorMessage("必须创建一个选项！");
        }
    }

    $(function() {
        itemModel = new tonto.Model("item_model", options.columns, {
            server: false
        });
        itemModel.toEdit();
    });
    </script>
</body>

</html>